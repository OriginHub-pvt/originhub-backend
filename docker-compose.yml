services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: originhub-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-originhub}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-originhub123}
      POSTGRES_DB: ${POSTGRES_DB:-originhub}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - ./volumes/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-originhub}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - originhub-network

  # Weaviate Vector Database
  weaviate:
    image: semitechnologies/weaviate:1.33.1
    container_name: originhub-weaviate
    ports:
      - "${WEAVIATE_PORT:-8080}:8080"
    environment:
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: "true"
      PERSISTENCE_DATA_PATH: "/var/lib/weaviate"
      DEFAULT_VECTORIZER_MODULE: "none"
      ENABLE_MODULES: "text2vec-openai,text2vec-cohere,text2vec-huggingface,ref2vec-centroid,generative-openai,qna-openai"
      CLUSTER_HOSTNAME: "node1"
    volumes:
      - ./volumes/weaviate:/var/lib/weaviate
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8080/v1/.well-known/ready",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - originhub-network

  # FastAPI Application
  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: originhub-api
    # Entrypoint script will handle migrations, then run this command
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    volumes:
      - ..:/app
      - /app/__pycache__
    ports:
      - "${API_PORT:-8000}:8000"
    environment:
      # Agentic API (OpenAI replacement)
      # Use host.docker.internal so the container can reach the hostâ€™s 8004
      - ORIGINHUB_API_URL=${ORIGINHUB_API_URL:-http://host.docker.internal:8004}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-originhub}:${POSTGRES_PASSWORD:-originhub123}@postgres:5432/${POSTGRES_DB:-originhub}
      - WEAVIATE_URL=http://weaviate:8080
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER:-originhub}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-originhub123}
      - POSTGRES_DB=${POSTGRES_DB:-originhub}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000}
      - CLERK_WEBHOOK_SECRET=${CLERK_WEBHOOK_SECRET:-}
    depends_on:
      postgres:
        condition: service_healthy
      weaviate:
        condition: service_healthy
    networks:
      - originhub-network
    restart: unless-stopped

networks:
  originhub-network:
    driver: bridge
